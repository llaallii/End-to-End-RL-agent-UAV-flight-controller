%% D1.5 - Custom Hardware Architecture (Flight-Ready PCB)
%% UAV Flight Controller with On-Board Reinforcement Learning
%% Priority 3 - Hardware Detail
%% Placement: 05_WBS_Phase5_Custom_Hardware.md (Section 5.3)

graph TB
    %% Power System
    subgraph PowerSystem["Power Management System"]
        Battery["LiPo Battery<br/>3S-4S (11.1V - 14.8V)<br/>2200-5000 mAh"]
        BEC["5V/3.3V BEC<br/>Buck Converter<br/>3A continuous"]
        PowerMon["Battery Monitor<br/>Voltage/Current sensor<br/>I2C interface"]
        ProtCircuit["Protection Circuit<br/>Overcurrent/Overvoltage<br/>Reverse polarity"]
    end
    
    %% Main MCU Section
    subgraph MCU["Main Microcontroller Unit"]
        Processor["STM32F7 or F4<br/>ARM Cortex-M7<br/>216 MHz, 512KB Flash<br/>256KB RAM"]
        RealTimeClock["RTC<br/>32.768 kHz crystal"]
        BootLoader["Bootloader<br/>UART/USB DFU"]
        JTAG["JTAG/SWD Debug<br/>10-pin connector"]
    end
    
    %% Sensors
    subgraph Sensors["Sensor Suite"]
        IMU["IMU (SPI)<br/>MPU-9250 or BMI088<br/>Accel + Gyro + Mag<br/>1 kHz sample rate"]
        Baro["Barometer (I2C)<br/>MS5611 or BMP388<br/>Altitude estimation"]
        GPS["GPS Module (UART)<br/>u-blox M8N/M9N<br/>5-10 Hz update"]
        Mag["Magnetometer (I2C)<br/>HMC5883L or LIS3MDL<br/>Compass/heading"]
        OptFlow["Optical Flow (opt)<br/>PMW3901<br/>Velocity estimation"]
    end
    
    %% Motor Interfaces
    subgraph MotorControl["Motor Control Interface"]
        ESC1["ESC 1 (PWM/DShot)<br/>Motor front left"]
        ESC2["ESC 2 (PWM/DShot)<br/>Motor front right"]
        ESC3["ESC 3 (PWM/DShot)<br/>Motor rear left"]
        ESC4["ESC 4 (PWM/DShot)<br/>Motor rear right"]
        MotorPower["Motor Power Rail<br/>11.1V - 14.8V<br/>High current traces"]
    end
    
    %% Communication Interfaces
    subgraph CommInterfaces["Communication Interfaces"]
        USB["USB Interface<br/>Micro-B or USB-C<br/>Configuration/Logging"]
        UART1["UART1<br/>GPS module"]
        UART2["UART2<br/>Telemetry (MAVLink)"]
        UART3["UART3<br/>Debug console"]
        I2C_Bus["I2C Bus<br/>Sensors + expansion"]
        SPI_Bus["SPI Bus<br/>High-speed sensors"]
    end
    
    %% Radio & Telemetry
    subgraph RadioTelem["Radio & Telemetry"]
        RCReceiver["RC Receiver<br/>SBUS/PPM/CRSF<br/>UART interface"]
        Telemetry["Telemetry Radio<br/>900MHz/433MHz<br/>UART to GCS"]
        LEDIndicators["RGB Status LED<br/>Visual feedback<br/>PWM or SPI"]
        Buzzer["Piezo Buzzer<br/>Audio alerts<br/>GPIO PWM"]
    end
    
    %% Storage
    subgraph Storage["Data Storage"]
        SDCard["SD Card Slot<br/>SDIO interface<br/>Black box logging<br/>FAT32 filesystem"]
        Flash["External Flash (opt)<br/>SPI NOR/NAND<br/>8-16 MB<br/>Firmware + logs"]
    end
    
    %% Expansion & Debug
    subgraph Expansion["Expansion & Debug"]
        ExpHeader["Expansion Header<br/>GPIO, ADC, I2C, SPI<br/>2x10 pin"]
        LED_Strip["LED Strip Output<br/>WS2812B compatible<br/>Navigation lights"]
        VoltSense["Voltage Dividers<br/>Battery monitoring<br/>ADC inputs"]
    end
    
    %% Power Distribution
    Battery --> ProtCircuit
    ProtCircuit --> BEC
    ProtCircuit --> MotorPower
    ProtCircuit --> PowerMon
    
    BEC -->|"5V"| Processor
    BEC -->|"3.3V"| IMU
    BEC -->|"3.3V"| Baro
    BEC -->|"5V"| GPS
    BEC -->|"3.3V"| Mag
    BEC -->|"3.3V"| SDCard
    
    PowerMon -->|"I2C"| I2C_Bus
    
    %% MCU Connections - Sensors
    Processor -->|"SPI1"| SPI_Bus
    SPI_Bus --> IMU
    
    Processor -->|"I2C1"| I2C_Bus
    I2C_Bus --> Baro
    I2C_Bus --> Mag
    
    Processor -->|"UART4"| UART1
    UART1 --> GPS
    
    Processor -->|"SPI2 (opt)"| OptFlow
    
    %% MCU Connections - Motors
    Processor -->|"TIM1_CH1"| ESC1
    Processor -->|"TIM1_CH2"| ESC2
    Processor -->|"TIM1_CH3"| ESC3
    Processor -->|"TIM1_CH4"| ESC4
    
    MotorPower --> ESC1
    MotorPower --> ESC2
    MotorPower --> ESC3
    MotorPower --> ESC4
    
    %% MCU Connections - Communication
    Processor -->|"USB OTG"| USB
    Processor -->|"UART2"| UART2
    UART2 --> Telemetry
    Processor -->|"UART3"| UART3
    Processor -->|"UART5"| RCReceiver
    
    %% MCU Connections - Storage
    Processor -->|"SDIO"| SDCard
    Processor -->|"SPI3 (opt)"| Flash
    
    %% MCU Connections - Indicators
    Processor -->|"GPIO/PWM"| LEDIndicators
    Processor -->|"TIM2_CH1"| Buzzer
    Processor -->|"SPI/WS2812"| LED_Strip
    
    %% MCU Connections - Expansion
    Processor --> ExpHeader
    Processor -->|"ADC1"| VoltSense
    VoltSense -.->|"Monitor"| Battery
    
    %% Debug
    Processor --> JTAG
    Processor --> BootLoader
    BootLoader --> USB
    
    RealTimeClock --> Processor
    
    %% Annotations
    PCBNote[/"PCB Specifications:<br/>• 4-layer board (signal/gnd/power/signal)<br/>• Dimensions: 50mm x 50mm (standard 30.5mm hole pattern)<br/>• Mounting: M3 holes, vibration dampening<br/>• Connectors: JST-GH (small) or XT30/60 (power)"/]
    
    PowerSystem -.-> PCBNote
    
    TimingNote[/"Key Timing:<br/>• IMU: 1 kHz SPI read<br/>• Motors: 400 Hz - 2 kHz PWM/DShot<br/>• GPS: 5-10 Hz UART<br/>• Baro: 50 Hz I2C"/]
    
    Sensors -.-> TimingNote
    
    %% Styling
    classDef power fill:#F5A623,stroke:#333,stroke-width:2px,color:#000
    classDef mcu fill:#4A90E2,stroke:#333,stroke-width:3px,color:#fff
    classDef sensor fill:#7ED321,stroke:#333,stroke-width:2px,color:#000
    classDef motor fill:#D0021B,stroke:#333,stroke-width:2px,color:#fff
    classDef comm fill:#50E3C2,stroke:#333,stroke-width:2px,color:#000
    classDef storage fill:#9013FE,stroke:#333,stroke-width:2px,color:#fff
    classDef expansion fill:#B8E986,stroke:#333,stroke-width:2px,color:#000
    classDef annotation fill:#E0E0E0,stroke:#333,stroke-width:1px,color:#000
    
    class Battery,BEC,PowerMon,ProtCircuit,MotorPower power
    class Processor,RealTimeClock,BootLoader,JTAG mcu
    class IMU,Baro,GPS,Mag,OptFlow sensor
    class ESC1,ESC2,ESC3,ESC4 motor
    class USB,UART1,UART2,UART3,I2C_Bus,SPI_Bus,RCReceiver,Telemetry,LEDIndicators,Buzzer comm
    class SDCard,Flash storage
    class ExpHeader,LED_Strip,VoltSense expansion
    class PCBNote,TimingNote annotation

%% Custom Hardware Architecture Summary:
%% 
%% Core Components:
%%   - STM32F7/F4 MCU (216 MHz, 512KB Flash, 256KB RAM)
%%   - MPU-9250/BMI088 IMU (9-axis, 1 kHz SPI)
%%   - MS5611/BMP388 Barometer (I2C)
%%   - u-blox M8N/M9N GPS (UART)
%%   - 4x ESC interfaces (PWM/DShot)
%% 
%% Power System:
%%   - 3S-4S LiPo input (11.1V - 14.8V)
%%   - 5V/3.3V BEC (3A continuous)
%%   - Protection circuit (overcurrent, overvoltage, reverse polarity)
%%   - Battery voltage/current monitoring (I2C)
%% 
%% Communication:
%%   - USB (configuration, firmware update, logging)
%%   - 3x UART (GPS, telemetry, debug)
%%   - I2C (sensors, expansion)
%%   - SPI (high-speed sensors, optional flash)
%%   - SDIO (SD card for black box logging)
%% 
%% Interfaces:
%%   - JTAG/SWD debug (10-pin)
%%   - RC receiver (SBUS/PPM/CRSF)
%%   - Telemetry radio (MAVLink)
%%   - Status LED, buzzer, LED strip
%%   - Expansion header (GPIO, ADC, I2C, SPI)
%% 
%% PCB Design:
%%   - 4-layer board (signal/ground/power/signal)
%%   - 50mm x 50mm, standard 30.5mm mounting holes
%%   - High-current traces for motor power
%%   - Low-noise layout for sensors
%%   - Vibration dampening mounts
%% 
%% Bill of Materials (BOM):
%%   - ~60-80 components total
%%   - Cost estimate: $80-120 USD (small batch)
%%   - Lead time: 2-3 weeks (PCB fab + assembly + shipping)
